(()=>{var e={389:(e,s,t)=>{const i=t(185);i.connect(process.env.MONGO_DB_KEY).then((()=>console.log("Connected to MongoDB âœ”"))).catch((e=>{console.error("Failed to connect to MongoDB âœ–"),console.error(e)})),i.connection.on("error",console.error);const r=t(860),a=r();a.use(((e,s,t)=>{if(s.setHeader("Access-Control-Allow-Origin","*"),s.setHeader("Access-Control-Allow-Headers","Authorization, Content-Type"),s.setHeader("Access-Control-Allow-Methods","GET, POST, PUT, DELETE"),"OPTIONS"===e.method)return s.sendStatus(200);t()})),a.use("/images",r.static("images")),a.use(r.json());const o=t(327),n=t(616);a.use("/api/auth",o),a.use("/api/sauces",n),e.exports=a},36:(e,s,t)=>{const i=t(147),r=t(10),a="images/",o="images/tmp/",n=e=>{i.unlinkSync(a+e)},u=e=>{i.unlinkSync(o+e)},c=e=>{const s=o+e,t=a+e;i.renameSync(s,t)};s.getAllSauces=(e,s)=>{r.find().then((e=>s.status(200).json(e))).catch((e=>s.status(500).json({message:e.message})))},s.createSauce=async(e,s)=>{if(!e.file)return s.status(400).json({message:"Image requise."});const t=e.body.sauce?JSON.parse(e.body.sauce):{},i=e.file.filename;t.userId=s.locals.userId,t.imageUrl=`${e.protocol}://${e.get("host")}/images/${i}`;try{await r.create({...t,likes:0,dislikes:0,usersLiked:[],usersDisliked:[]}),c(i),s.status(201).json({message:"Sauce enregistrÃ©e !"})}catch(e){u(i),s.status(400).json({message:e.message})}},s.getOneSauce=(e,s)=>{s.status(200).json(s.locals.sauce)},s.updateSauce=async(e,s)=>{const t=s.locals.sauce;if(e.headers["content-type"].includes("multipart/form-data")){if(!e.file)return s.status(400).json({message:"Image requise."});const i=e.body.sauce?JSON.parse(e.body.sauce):{},r=e.file.filename,a=t.imageUrl.split("/images/")[1];i.imageUrl=`${e.protocol}://${e.get("host")}/images/${r}`,delete i.likes,delete i.dislikes,delete i.usersLiked,delete i.usersDisliked,Object.assign(t,i);try{await t.save(),n(a),c(r),s.status(200).json({message:"Sauce modifiÃ©e !"})}catch(e){u(r),s.status(400).json({message:e.message})}}else{const i={...e.body};delete i.imageUrl,delete i.likes,delete i.dislikes,delete i.usersLiked,delete i.usersDisliked,Object.assign(t,i),t.save().then((()=>s.status(200).json({message:"Sauce modifiÃ©e !"}))).catch((e=>s.status(400).json({message:e.message})))}},s.deleteSauce=(e,s)=>{const t=s.locals.sauce,i=t.imageUrl.split("/images/")[1];n(i),r.deleteOne({_id:t._id}).then((()=>s.status(200).json({message:"Sauce supprimÃ©e !"}))).catch((e=>s.status(400).json({message:e.message})))},s.likeSauce=(e,s)=>{const t=s.locals.userId,i=s.locals.sauce,r=e.body.like;let a;try{switch((e=>{if(null==e)throw Error("L'Ã©tat du like est requis.");if("number"!=typeof e)throw Error("L'Ã©tat du like doit Ãªtre un nombre.");if(!(e>=-1&&e<=1))throw Error("L'Ã©tat du like doit Ãªtre compris entre -1 et 1.")})(r),r){case 1:if(i.hasLiked(t))throw Error("Sauce dÃ©jÃ  likÃ©e...");i.hasDisliked(t)&&i.undislike(t),i.like(t),a="Sauce likÃ©e !";break;case-1:if(i.hasDisliked(t))throw Error("Sauce dÃ©jÃ  dislikÃ©e...");i.hasLiked(t)&&i.unlike(t),i.dislike(t),a="Sauce dislikÃ©e !";break;case 0:case 0:if(i.hasLiked(t))i.unlike(t),a="Sauce unlikÃ©e !";else{if(!i.hasDisliked(t))throw Error("Sauce pas likÃ©e ni dislikÃ©e...");i.undislike(t),a="Sauce undislikÃ©e !"}}}catch(e){return s.status(400).json({message:e.message})}i.save().then((()=>s.status(200).json({message:a}))).catch((e=>s.status(400).json({message:e.message})))}},612:(e,s,t)=>{const i=t(96),r=t(344),a=t(862),o=e=>{if(""===e||null==e)throw Error("Mot de passe requis.");if("string"!=typeof e)throw Error("Le mot de passe doit Ãªtre une chaÃ®ne de caractÃ¨res.");if(!(e.length<=50))throw Error("Le mot de passe ne doit pas excÃ©der 50 caractÃ¨res.")};s.signup=async(e,s)=>{try{const t=e.body.email,r=e.body.password;o(r);const n=await i.hash(r,10);await a.create({email:t,password:n}),s.status(201).json({message:"Utilisateur crÃ©Ã© !"})}catch(e){s.status(400).json({message:e.message})}},s.login=async(e,s)=>{try{const t=e.body.email,n=e.body.password,u=await a.findOne({email:t});if(!u)return s.status(400).json({message:"Utilisateur non trouvÃ©..."});if(o(n),!await i.compare(n,u.password))return s.status(401).json({message:"Mot de passe incorrect..."});const c=u._id,l=r.sign({userId:c},process.env.TOKEN_SECRET_KEY,{expiresIn:"24h"});s.status(200).json({userId:c,token:l})}catch(e){s.status(400).json({message:e.message})}}},752:(e,s,t)=>{const i=t(344);s.token=(e,s,t)=>{try{const r=e.headers.authorization?.split(" ")[1],a=i.verify(r,process.env.TOKEN_SECRET_KEY);s.locals.userId=a.userId,t()}catch(e){s.status(401).json(e)}},s.sauce=(e,s,t)=>{const i=s.locals.userId;if(s.locals.sauce.userId!==i)return s.status(403).json({message:"Sauce non possÃ©dÃ©e..."});t()}},429:(e,s,t)=>{const i=t(738),r=["jpg","jpeg","png"],a=i.diskStorage({destination:(e,s,t)=>t(null,"images/tmp"),filename:(e,s,t)=>{const i=Date.now(),r=Math.random().toString().slice(2);let a=s.mimetype.split("/")[1];"jpeg"===a&&(a="jpg"),t(null,`sauce_${i}_${r}.${a}`)}}),o=(e,s,t)=>{const i=s.mimetype.split("/")[1];if(!r.includes(i))return t(Error(`Image invalide (extensions autorisÃ©es : ${r.join("/")}).`));t(null,!0)};e.exports=(e,s,t)=>{i({storage:a,fileFilter:o}).single("image")(e,s,(e=>{if(e)return s.status(400).json({message:e.message});t()}))}},10:(e,s,t)=>{const i=t(185),r=i.Schema({userId:{type:String,required:!0,immutable:!0},name:{type:String,required:[!0,"Le nom est requis."],maxLength:[50,"Le nom ne doit pas excÃ©der 50 caractÃ¨res."],match:[/^[a-zA-Z]*$/,"Le nom est invalide."]},manufacturer:{type:String,required:!0,maxLength:50,match:/^[a-zA-Z]*$/},description:{type:String,required:!0,maxLength:500},mainPepper:{type:String,required:!0,maxLength:50,match:/^[a-zA-Z]*$/},imageUrl:{type:String,required:!0},heat:{type:Number,required:!0,min:1,max:10},likes:{type:Number,required:!0},dislikes:{type:Number,required:!0},usersLiked:{type:[String],required:!0},usersDisliked:{type:[String],required:!0}});r.methods.like=function(e){this.likes++,this.usersLiked.push(e)},r.methods.dislike=function(e){this.dislikes++,this.usersDisliked.push(e)},r.methods.unlike=function(e){this.likes--,this.usersLiked.splice(this.usersLiked.indexOf(e),1)},r.methods.undislike=function(e){this.dislikes--,this.usersDisliked.splice(this.usersDisliked.indexOf(e),1)},r.methods.hasLiked=function(e){return this.usersLiked.find((s=>s===e))},r.methods.hasDisliked=function(e){return this.usersDisliked.find((s=>s===e))},e.exports=i.model("Sauce",r)},862:(e,s,t)=>{const i=t(185),r=t(288),a=i.Schema({email:{type:String,unique:!0,lowercase:!0,required:!0,maxLength:50,match:/^[a-zA-Z0-9.!#$%&â€™*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/},password:{type:String,required:!0}});a.plugin(r),e.exports=i.model("User",a)},616:(e,s,t)=>{const i=t(860).Router(),r=t(752),a=t(429),o=t(10),n=t(36);i.use(r.token),i.route("/").get(n.getAllSauces).post(a,n.createSauce),i.route("/:id").get(n.getOneSauce).put(r.sauce,a,n.updateSauce).delete(r.sauce,n.deleteSauce),i.post("/:id/like",n.likeSauce),i.param("id",(async(e,s,t,i)=>{try{const e=await o.findById(i);if(!e)return s.status(404).json({message:"Sauce introuvable..."});s.locals.sauce=e,t()}catch(e){s.status(400).json({message:e.message})}})),e.exports=i},327:(e,s,t)=>{const i=t(860).Router(),r=t(612);i.post("/signup",r.signup),i.post("/login",r.login),e.exports=i},96:e=>{"use strict";e.exports=require("bcrypt")},142:e=>{"use strict";e.exports=require("dotenv")},860:e=>{"use strict";e.exports=require("express")},344:e=>{"use strict";e.exports=require("jsonwebtoken")},185:e=>{"use strict";e.exports=require("mongoose")},288:e=>{"use strict";e.exports=require("mongoose-unique-validator")},738:e=>{"use strict";e.exports=require("multer")},147:e=>{"use strict";e.exports=require("fs")},685:e=>{"use strict";e.exports=require("http")}},s={};function t(i){var r=s[i];if(void 0!==r)return r.exports;var a=s[i]={exports:{}};return e[i](a,a.exports,t),a.exports}(()=>{t(142).config();const e=t(685),s=t(389),i=e.createServer(s);try{i.listen(process.env.PORT||3e3)}catch(e){console.error(e),process.exit(1)}i.on("listening",(()=>{console.log("Welcome to Piiquante ðŸŒ¶"),console.log(`Listening on port ${i.address().port} âœ”`)})),i.on("error",(e=>{console.error(e),process.exit(1)}))})()})();